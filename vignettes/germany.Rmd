---
title: "Germany analysis of covid-19 cases"
output: 
    html_document:
        toc: true
        dev: 'svg'
params:
    death.start: !r 5
    confirmed.start: !r 100
    duplicate.every: !r 2
    last.days: !r 12
---

# Preface

This is a personal analysis of the cases of covid-19.

I'm not from the Epidemiology field. I'm currently working on modeling cancer datasets for my PhD thesis.

```{r render.me, include=FALSE, eval=FALSE}
rmarkdown::render('Bavaria.Rmd', quiet = TRUE)
```

```{r render.site, include=FALSE, eval=FALSE}
rmarkdown::render_site(quiet = TRUE)
rmarkdown::clean_site()
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, fig.width = 10, fig.height = 8)
library(tidyverse)
library(dplyr)
library(viridis) # color pallete
library(ggrepel)
library(zoo)
library(glue)
library(DT)
library(anytime)
library(scales)
library(futile.logger)
library(wbstats) # world bank data
library(reshape2)
library(eurostat)

Sys.setlocale('LC_TIME', 'en_GB.UTF-8')
.Last.value <- flog.layout(layout.format('~m'))
```

# Data

Data was retrieved from *'RamiKrispin/coronavirus'* R data package which is updated daily in github.com.

It's not realtime data and data presented may have 1 or more days of difference from real-time data. Check the caption on the figures to check when was the last data point.


```{r buildCorona, echo=FALSE, message=FALSE, warning=FALSE}
eu.de.raw <- read_csv('https://github.com/covid19-eu-zh/covid19-eu-data/raw/master/dataset/covid-19-de.csv')

eu.de <- eu.de.raw %>%
    mutate(nuts_1 = gsub('[\u00ad]', '', nuts_1)) %>%
    filter(nuts_1 != 'Repatriierte') %>%
    select(country = nuts_1, cases, deaths, date = datetime) %>%
    group_by(country) %>% 
    melt(id.vars = c('country', 'date'), variable.name = 'type', value.name = 'cases') %>%
    mutate(type = if_else(type == 'cases', 'confirmed', 'death')) %>%
    arrange(desc(date)) %>%
    group_by(country, type) %>% 
    mutate(date = anydate(format(date, '%Y/%m/%d')),
           cumul = cases,
           # need to break down differences between days
           cases = rollapply(cases, 2, function(ix) { if(length(ix) <= 1) { return(ix) } else { ix[1] - sum(ix[-1]) } }, fill = c(0, 0, 0), align = 'left', partial = TRUE))

my.corona.original <- eu.de

source.by = 'Robert Koch Institute'
```


```{r summaryCorona, echo=FALSE, collapse=TRUE}
flog.info('### Summary of data ###')
flog.info('')
flog.info('     States: %d', my.corona.original %>% filter(cases > 0) %>% pull(country) %>% unique %>% length)
flog.info('')
flog.info('      Cases: %d', sum((my.corona.original %>% filter(type == 'confirmed'))$cases))
flog.info('     Deaths: %d', sum((my.corona.original %>% filter(type == 'death'))$cases))
flog.info('')

last.date <- format(max(my.corona.original$date), '%Y/%m/%d')
last.date.string <- paste0('Latest date from ', last.date, ' (source: ', source.by, ')')

flog.info('     Latest: %s from %s', last.date, source.by)
```


## States in visualizations

The plots presented get very complex as more states are added.

```{r, echo=FALSE, collapse=TRUE, include=TRUE}
countries <- my.corona.original %>% pull(country) %>% unique %>% sort

flog.info('Looking only at the following states: \n\n  %s' , paste0(countries, collapse = ', '))
```

# Top 30 countries {.tabset .tabset-fade .tabset-pills}

## Total Confirmed cases

```{r top30confirmed, echo=FALSE}
my.corona.original %>%
    filter(type == 'confirmed') %>%
    group_by(country, type) %>%
    summarise(cases = sum(cases)) %>%
    arrange(cases) %>%
    ungroup() %>%
    mutate(country = paste0(country, ' (', cases, ')')) %>%
    mutate(country = factor(country, levels = unique(.$country))) %>%
    top_n(30, cases) %>%
    ggplot() +
        geom_bar(aes(country, cases, fill = country), stat = 'identity') +
        # scale_y_continuous(trans = 'log10') +
        coord_flip() +
        labs(x = 'Confirmed Cases', 
             y = '', 
             title = 'Confirmed Cases by Country' , 
             susubtitle = 'only showing top 30',
             caption = last.date.string) + 
        theme_minimal() + 
        theme(legend.position = 'none')
```

## Total Deaths

```{r top30deaths, echo=FALSE}
my.corona.original %>%
    filter(type == 'death') %>%
    group_by(country, type) %>%
    summarise(cases = sum(cases)) %>%
    arrange(cases) %>%
    ungroup() %>%
    mutate(country = paste0(country, ' (', cases, ')')) %>%
    mutate(country = factor(country, levels = unique(.$country))) %>%
    filter(cases > 0) %>%
    top_n(30, cases) %>%
    ggplot() +
        geom_bar(aes(country, cases, fill = country), stat = 'identity') +
        # scale_y_continuous(trans = 'log10') +
        coord_flip() +
        labs(x = 'Deaths', 
             y = '', 
             title = 'Deaths by Country' , 
             subtitle = 'only showing top 30',
             caption = last.date.string) + 
        theme_minimal() + 
        theme(legend.position = 'none')
```

## Data confirmed

```{r data.confirmed}
my.corona.original %>%
    filter(type == 'confirmed') %>%
    group_by(country, type) %>%
    summarise(cases = sum(cases)) %>%
    arrange(cases) %>%
    ungroup() %>%
    filter(cases > 0) %>%
    arrange(-cases) %>%
    mutate(cases = format(cases, big.mark = ',')) %>%
    select(Country = country, 'Cases Confirmed' = cases) %>%
    datatable()
```

## Data death

```{r data.death}
my.corona.original %>%
    filter(type == 'death') %>%
    group_by(country, type) %>%
    summarise(cases = sum(cases)) %>%
    arrange(cases) %>%
    ungroup() %>%
    filter(cases > 0) %>%
    arrange(-cases) %>%
    mutate(cases = format(cases, big.mark = ',')) %>%
    select(Country = country, 'Cases Death' = cases) %>%
    datatable()
```

```{r eurostat}
eu.population.raw <- get_eurostat('tgs00096')

eu.population.norm <- eu.population.raw %>% 
    filter(grepl('^DE', geo)) %>%
    mutate(nuts_1 = substr(geo, 0, 3),
           nuts_1_label = label_eurostat(nuts_1, dic = 'geo')) %>%
    group_by(nuts_1, nuts_1_label) %>%
    filter(time == max(time)) %>%
    summarize(values = sum(values))

populations <- eu.population.norm %>%
    ungroup() %>%
    select(country = nuts_1_label, population = values)

my.corona <- my.corona.original %>% 
    left_join(populations, by = 'country')

my.corona <- mutate(my.corona, 
                    country.data = factor(country, levels = my.corona %>% filter(type == 'confirmed') %>% summarise(cases = max(cumul)) %>% arrange(cases) %>% pull(country)))
```

```{r, echo=FALSE}
my.corona.after.100 <- my.corona %>%
    #
    filter((type == 'death' & cumul >= params$death.start ) | 
           (type == 'confirmed' & cumul >= params$confirmed.start) | 
           (type == 'recovered' & cumul >= 0)) %>%
    arrange(date) %>%
    mutate(days.after.100 = as.numeric(difftime(date, min(date), units = 'days')))


```

# Confirmed cases / Deaths *(ommiting start of epidemic)*

## Starting point after exceeding `r params$confirmed.start` cases or `r params$death.start` deaths {.tabset .tabset-fade .tabset-pills}

The visualizations presented below have been time-shifted to the day when each country exceeded `r params$confirmed.start` cases or `r params$death.start` deaths *(depending on the visualization)*.

It is an arbitrary number, but allows to have a more accurate view of the progression as the first cases are quite sporadic and make the plots more complex.

**Important note**: All plots are in the logarithm scale *(base 2)* as it allows to better visualize when cases duplicate.

It is used because covid-19 cases grow very fast, and this way it becomes easier to read over time the number of cases. Always look at the y axis.

If you do not understand logarythm scale, I recommend this [video](https://www.youtube.com/watch?v=Kas0tIxDvrg).

### Confirmed cases  

```{r corfirmed.cases.after.100, echo=FALSE}
my.corona.after.100 %>%
    filter(country %in% countries) %>%
    filter(type == 'confirmed') %>%
    ungroup(country) %>%
    group_by(country) %>%
    arrange(-cases) %>% {
        tmp <- summarise(., cases = max(cumul))
        tmp <- arrange(tmp, cases)
        tmp <- mutate(tmp, country.data = paste0(country, ' (', cases, ')'))
        
        mutate(., country.data = factor(paste0(country, ' (', max(cumul), ')'),
                                        levels = rev(pull(tmp, country.data))))
        } %>%
    mutate(label = if_else(cumul == max(cumul), as.character(country.data), NA_character_)) %>%
    ungroup %>%
    ggplot(aes(x = days.after.100, y = cumul, color = country.data)) + 
        geom_line(size = 1.2) +
        geom_label_repel(aes(label = label,
                             fill = country.data), 
                         na.rm = TRUE,
                         color = 'white',
                         size = 3.5,
                         segment.alpha = .4,
                         segment.colour = 'black') +
        labs(y = 'Confirmed cases',
             x = 'Number of days since ≥ {params$confirmed.start} confirmed cases' %>% glue,
             title = 'Confirmed cases over time',
             subtitle = 'Only showing after each country had more than {params$confirmed.start} cases' %>% glue,
             caption = last.date.string) +
        scale_y_continuous('Confirmed cases (log2 scale)', trans = 'log2') + 
        scale_color_viridis(discrete = TRUE, end = .85, option = 'A') +
        scale_fill_viridis(discrete = TRUE, end = .85, option = 'A') +
        theme_minimal() +
        theme(legend.position = 'none', legend.title = element_blank())
```

### Patient deaths

```{r death.after.100, echo=FALSE}
my.corona.after.100 %>%
    filter(country %in% countries) %>%
    filter(type == 'death') %>%
    group_by(country) %>% {
        tmp <- summarise(., cases = max(cumul))
        tmp <- arrange(tmp, cases)
        tmp <- mutate(tmp, country.data = paste0(country, ' (', cases, ')'))
        
        mutate(., country.data = factor(paste0(country, ' (', max(cumul), ')'),
                                        levels = rev(pull(tmp, country.data))))
        } %>%
    mutate(label = if_else(cumul == max(cumul), as.character(country.data), NA_character_)) %>%
    ungroup %>%
    ggplot(aes(x = days.after.100, y = cumul, color = country.data)) + 
        # geom_point(aes(date, cumul, color = country)) +
        geom_line(size = 1.2) +
        geom_label_repel(aes(label = label,
                             fill = country.data), 
                             na.rm = TRUE,
                             color = 'white',
                             size = 3.5,
                             segment.alpha = .4,
                             segment.colour = 'black') +
        labs(y = 'Deaths',
             x = glue('Number of days since ≥ {params$death.start} deaths'),
             title = 'Deaths over Time',
             subtitle = 'Only showing after each country had more than {params$death.start} deaths' %>% glue,
             caption = last.date.string) +
        scale_y_continuous('Deaths (log2 scale)', trans = 'log2') + 
        scale_color_viridis(discrete = TRUE, end = .85, option = 'A') +
        scale_fill_viridis(discrete = TRUE, end = .85, option = 'A') +
        theme_minimal() +
        theme(legend.position = 'none', legend.title = element_blank())
```

## Starting point after exceeding `r params$confirmed.start` cases or `r params$death.start` deaths *(per 100k population)* {.tabset .tabset-fade .tabset-pills}

Showing population for plotted states. This becomes relevant for the next plots.

### Confirmed cases

```{r confirmed.after.100.per100k, echo=FALSE}
my.corona.after.100 %>%
    filter(country %in% countries) %>%
    filter(type %in% c('confirmed')) %>%
    mutate(cumul.per.100k = cumul / population * 100000) %>%
    group_by(country) %>% {
        tmp <- summarise(., cases = round(max(cumul.per.100k), digits = 2))
        tmp <- arrange(tmp, cases)
        tmp <- mutate(tmp, country.data = paste0(country, ' (', cases, ')'))
        
        mutate(., country.data = factor(paste0(country, ' (', round(max(cumul.per.100k), digits = 2), ')'),
                                        levels = rev(pull(tmp, country.data))))
        } %>%
    mutate(label = if_else(cumul.per.100k == max(cumul.per.100k), as.character(country.data), NA_character_)) %>%
    ungroup %>%
    ggplot(aes(x = days.after.100, y = cumul.per.100k, color = country.data)) + 
        geom_line(size = 1.2) +
        geom_label_repel(aes(label = label,
                                 fill = country.data), 
                             na.rm = TRUE,
                             color = 'white',
                             size = 3.5,
                             segment.alpha = .4,
                             segment.colour = 'black') +
        labs(x = 'Number of days since ≥ 100 cases',
             y = 'Confirmed cases -- per 100k population',
             title = 'Confirmed cases per 100k population',
             subtitle = 'Only showing after each country had more than 100 cases',
             caption = last.date.string) + 
        scale_y_continuous('Confirmed cases -- per 100k population (log2 scale)', trans = 'log2') +
        scale_color_viridis(discrete = TRUE, end = .85, option = 'C') +
        scale_fill_viridis(discrete = TRUE, end = .85, option = 'C') +
        theme_minimal() +
        theme(legend.position = 'none', legend.title = element_blank())
```

### Deaths 

```{r death.after.100.per.100k, echo=FALSE}
my.corona.after.100 %>%
    filter(country %in% countries) %>%
    filter(type %in% c('death')) %>%
    mutate(cumul = cumul / population * 100000) %>%
    group_by(country) %>% {
        tmp <- summarise(., cases = round(max(cumul), digits = 2))
        tmp <- arrange(tmp, cases)
        tmp <- mutate(tmp, country.data = paste0(country, ' (', cases, ')'))
        
        mutate(., country.data = factor(paste0(country, ' (', round(max(cumul), digits = 2), ')'),
                                        levels = rev(pull(tmp, country.data))))
        } %>%
    mutate(label = if_else(cumul == max(cumul), as.character(country.data), NA_character_)) %>%
    ungroup %>%
    ggplot(aes(x = days.after.100, y = cumul, color = country.data)) + 
        geom_line(size = 1.2) +
        geom_label_repel(aes(label = label,
                                 fill = country.data), 
                             na.rm = TRUE,
                             color = 'white',
                             size = 3.5,
                             segment.alpha = .4,
                             segment.colour = 'black') +
        labs(x = 'Number of days since ≥ {params$death.start} deaths' %>% glue,
             y = 'Deaths -- per 100k population',
             title = 'Deaths per 100k population',
             subtitle = 'Only showing after each country had more than {params$death.start} deaths' %>% glue,
             caption = last.date.string) + 
        scale_y_continuous('Deaths -- per 100k population (log2 scale)', trans = 'log2') + 
        scale_color_viridis(discrete = TRUE, end = .85, option = 'C') +
        scale_fill_viridis(discrete = TRUE, end = .85, option = 'C') +
        theme_minimal() +
        theme(legend.position = 'none', legend.title = element_blank())
```

### Population data

```{r population.data, echo=FALSE}
my.corona %>% 
    filter(country %in% countries) %>% 
    ungroup %>% 
    select(country, population) %>% 
    distinct(country, .keep_all = TRUE) %>%
    arrange(population) %>%
    mutate(population = format(population, big.mark = ',', trim = FALSE)) %>%
    datatable()
```

# Last `r params$last.days` days {.tabset .tabset-fade .tabset-pills}

Instead of showing the evolution of the cases/deaths since a country exceeded 100/10 cases, it insteads shows the last 12 days.

The first data point is the number of new cases that day.

## Confirmed cases 

```{r confirmed.last12.days, echo=FALSE}
my.corona.after.100 %>%
    filter(country %in% countries) %>%
    filter(type == 'confirmed') %>%
    arrange(country) %>%
    top_n(params$last.days, days.after.100) %>%
    mutate(days.before.now = days.after.100 - max(days.after.100)) %>%
    mutate(cumul = cumsum(cases)) %>%
    group_by(country) %>% {
        tmp <- summarise(., cases = max(cumul))
        tmp <- arrange(tmp, cases)
        tmp <- mutate(tmp, country.data = paste0(country, ' (', cases, ')'))
        
        mutate(., country.data = factor(paste0(country, ' (', max(cumul), ')'),
                                        levels = rev(pull(tmp, country.data))))
        } %>%
    mutate(label = if_else(cumul == max(cumul), as.character(country.data), NA_character_)) %>%
    ungroup %>%
    ggplot(aes(x = days.before.now, y = cumul, color = country.data)) + 
        geom_line(size = 1.2) +
        geom_label_repel(aes(label = label,
                                 fill = country.data), 
                             na.rm = TRUE,
                             color = 'white',
                             size = 3.5,
                             segment.colour = 'black',
                             segment.alpha = .4) +
        labs(x = paste0('Last ', params$last.days, ' days'),
             y = 'Confirmed cases',
             title = paste0('Confirmend Cases in the last ', params$last.days, ' days'),
             caption = last.date.string) + 
        scale_y_continuous('Confirmed cases (log2 scale)', trans = 'log2') + 
        scale_color_viridis(discrete = TRUE, end = .85, option = 'A') +
        scale_fill_viridis(discrete = TRUE, end = .85, option = 'A') +
        #
        theme_minimal() +
        theme(legend.position = 'none', legend.title = element_blank())
```

## Deaths

```{r death.last12.days, echo=FALSE, warning=FALSE}
my.corona.after.100 %>%
    filter(country %in% countries) %>%
    filter(type == 'death') %>%
    arrange(country) %>%
    top_n(params$last.days, days.after.100) %>%
    mutate(days.before.now = days.after.100 - max(days.after.100)) %>%
    mutate(cumul = cumsum(cases)) %>%
    group_by(country) %>% {
        tmp <- summarise(., cases = max(cumul))
        tmp <- arrange(tmp, cases)
        tmp <- mutate(tmp, country.data = paste0(country, ' (', cases, ')'))
        
        mutate(., country.data = factor(paste0(country, ' (', max(cumul), ')'),
                                        levels = rev(pull(tmp, country.data))))
        } %>%
    mutate(label = if_else(cumul == max(cumul), as.character(country.data), NA_character_)) %>%
    ungroup %>%
    ggplot(aes(x = days.before.now, y = cumul, color = country.data)) + 
        geom_line(size = 1.2) +
        geom_label_repel(aes(label = label,
                                 fill = country.data), 
                             na.rm = TRUE,
                             color = 'white',
                             size = 3.5,
                             segment.alpha = .4,
                             segment.colour = 'black') +
        labs(x = paste0('Last ', params$last.days, ' days'),
             y = 'Deaths',
             title = paste0('Deaths in the last ', params$last.days, ' days'),
             caption = last.date.string) + 
        scale_y_continuous('Deaths (log2 scale)', trans = 'log2') + 
        scale_color_viridis(discrete = TRUE, end = .85, option = 'B') +
        scale_fill_viridis(discrete = TRUE, end = .85, option = 'B') +
        theme_minimal() +
        theme(legend.position = 'none', legend.title = element_blank())
```

## Data for confirmed cases

**warning**: sub-total is only for last 12 days

```{r last.12.days.confirmed.data, echo=FALSE}
my.corona.after.100 %>%
    filter(country %in% countries) %>%
    filter(type == 'confirmed') %>%
    arrange(country) %>%
    top_n(params$last.days, days.after.100) %>%
    mutate(days.before.now = days.after.100 - max(days.after.100)) %>%
    mutate(cumul = cumsum(cases)) %>%
    ungroup() %>%
    mutate(Country = country,
           Date = format(date, '%B %d'),
           'Confirmed cases' = cases,
           'Sub-total' = cumul) %>%
    select(Country, Date, 'Confirmed cases', 'Sub-total') %>%
    datatable()
```

## Data for Deaths

**warning**: sub-total is only for last 12 days

```{r last.12.days.death.data, echo=FALSE}
my.corona.after.100 %>%
    filter(country %in% countries) %>%
    filter(type == 'death') %>%
    arrange(country) %>%
    top_n(params$last.days, days.after.100) %>%
    mutate(days.before.now = days.after.100 - max(days.after.100)) %>%
    mutate(cumul = cumsum(cases)) %>%
    ungroup() %>%
    mutate(Country = country,
           Date = format(date, '%B %d', tz = 'Europe/London'),
           'Deaths' = cases,
           'Sub-total' = cumul) %>%
    select(Country, Date, 'Deaths', 'Sub-total') %>%
    datatable()
```

# Cumulative cases of previous 4 days *(how it tracks over time)* {.tabset .tabset-fade .tabset-pills}

**Warning**: This visualization is not very intuitive, use it to see the trend over the last days.

```{r countries.more, echo=FALSE}
countries.always.include <- c()

countries.extended <- countries

# countries.extended[!countries.extended %in% my.corona$country]
# countries.extended[!countries.extended %in% populations$country]

# my.corona$country %>% unique %>% sort
# populations$country %>% unique %>% sort

last.week.tmp <- my.corona.original %>% 
    filter(country %in% countries.extended) %>%
    # filter(country == 'Portugal') %>%
    group_by(country, type) %>%
    arrange(desc(date)) %>%
    ungroup() %>%
    select(country, date, type, cases)

last.week <- 
    # Join confirmed and death cases
    left_join(last.week.tmp %>% filter(type == 'confirmed') %>% select(-type),
                        last.week.tmp %>% filter(type == 'death') %>% select(-type),
                        by = c('country', 'date'),
                        suffix = c('.confirmed', '.death')) %>%
    #
    # Replace any NA from join
    mutate(cases.confirmed = replace(cases.confirmed, is.na(cases.confirmed), 0),
           cases.death = replace(cases.death, is.na(cases.death), 0)) %>%
    #    
    # Calculate cumulative sum over date
    arrange(date) %>%
    group_by(country) %>%
    #
    # calculate cumulative cases (i.e. all cases reported up to that day)
    mutate(cumul.death = cumsum(cases.death),
           cumul.confirmed = cumsum(cases.confirmed)) %>% 
    arrange(desc(date)) %>%
    mutate(last.week.cases.confirmed = rollapply(cases.confirmed, 4, sum, align = 'left', fill = c(0,0,0), partial = TRUE)) %>%
    mutate(last.week.cases.death = rollapply(cases.death, 4, sum, align = 'left', fill = c(0,0,0), partial = TRUE)) %>%
    #
    #
    left_join(populations, by = 'country') %>%
    group_by(country) %>%
    arrange(date) %>%
    #
    mutate(deaths.per.100k = last.week.cases.death / population * 100000,
           confirmed.per.100k = last.week.cases.confirmed / population * 100000,
           ratio.deaths.per.confirmed = last.week.cases.death / last.week.cases.confirmed) 
```

## Confirmed cases

```{r confirmed.lastweek.cumulative, echo=FALSE}
p <- last.week %>% 
    filter(country %in% countries) %>%
    group_by(country) %>% {
        tmp <- summarise(., cases = last(last.week.cases.confirmed))
        tmp <- arrange(tmp, cases)
        tmp <- mutate(tmp, country.data = paste0(country, ' (', cases, ')'))
        
        mutate(., country.data = factor(paste0(country, ' (', last(last.week.cases.confirmed), ')'),
                                        levels = rev(pull(tmp, country.data))))
    } %>%
    mutate(label = if_else(date == max(date), as.character(country.data), NA_character_)) %>%
    #
    ggplot(aes(x = date, y = last.week.cases.confirmed, color = country.data)) +
        geom_line(size = 1.2) +
        geom_point(size = 1.2) +
                geom_label_repel(aes(label = label,
                                     fill = country.data), 
                                 na.rm = TRUE,
                                 color = 'white',
                                 size = 3.5,
                                 segment.alpha = .4,
                                 segment.colour = 'black') +
        labs(title = 'WARNING:: Each point is a sum from previous 4 days',
             y = 'Number of cases confirmed in previous 4 days',
             x = 'Date',
             caption = last.date.string) +
        scale_color_viridis(discrete = TRUE, end = .85, option = 'A') +
        scale_fill_viridis(discrete = TRUE, end = .85, option = 'A') +
        theme_minimal() +
        theme(legend.position = 'none')
p
# p + scale_y_continuous('Number of cases confirmed in previous 4 days (log2 scale)', trans = 'log2')
```

## Deaths

```{r death.lastweek.cumulative, echo=FALSE}
p <- last.week %>% 
    filter(country %in% countries) %>%
    group_by(country) %>% {
        tmp <- summarise(., cases = last(last.week.cases.death))
        tmp <- arrange(tmp, cases)
        tmp <- mutate(tmp, country.data = paste0(country, ' (', cases, ')'))
        
        mutate(., country.data = factor(paste0(country, ' (', last(last.week.cases.death), ')'),
                                        levels = rev(pull(tmp, country.data))))
    } %>%
    mutate(label = if_else(date == max(date), as.character(country.data), NA_character_)) %>%
    #
    ggplot(aes(x = date, y = last.week.cases.death, color = country.data)) +
        geom_line(size = 1.2) +
                geom_label_repel(aes(label = label,
                                     fill = country.data), 
                                 na.rm = TRUE,
                                 color = 'white',
                                 size = 3.5,
                                 segment.alpha = .4,
                                 segment.colour = 'black') +
        labs(title = 'WARNING:: Each point is a sum from previous 4 days',
             y = 'Number of deaths in previous 4 days',
             x = 'Date',
             caption = last.date.string) +
        scale_color_viridis(discrete = TRUE, end = .85, option = 'A') +
        scale_fill_viridis(discrete = TRUE, end = .85, option = 'A') +
        theme_minimal() +
        theme(legend.position = 'none')
p
# p + scale_y_continuous('Number of cases confirmed in previous 4 days (log2 scale)', trans = 'log2')
```

# Confirmed cases vs. Death visualizations *(per 100k population)* {.tabset .tabset-fade .tabset-pills}

This visualization shows the number of cases/deaths per 100k of the population.

* **x axis**: Confirmed cases per 100k population
* **y axis**: Deaths per 100k population
* **size of data point**: Total population if the country
* **label**: Rate of deaths per confirmed cases

```{r death.vs.cases.function.and.data, echo=FALSE}
death.vs.cases <- last.week %>%
    group_by(country, population) %>%
    summarise(ratio = max(cumul.death) / max(cumul.confirmed),
              cases.death = max(cumul.death / population * 100000), 
              cases.confirmed = max(cumul.confirmed / population * 100000)) %>%
    filter(cases.death > 0)

plot.death.vs.cases <- function(country.filter, always.include = countries.always.include) {
    return(death.vs.cases %>%
        filter(country %in% (c(always.include, country.filter) %>% unique)) %>%
        ggplot(aes(x = cases.confirmed, y = cases.death, color = country)) +
            geom_point(aes(size = population), alpha = .4) +
            geom_label_repel(aes(label = paste0(country, ' (', percent(ratio, accuracy = .1), ')'),
                                 fill = country),
                                 na.rm = TRUE,
                                 alpha = .8,
                                 color = 'white',
                                 size = 3,
                                 segment.alpha = .4,
                                 segment.colour = 'black',
                                 force = 2) +
            expand_limits(x = ceiling(max(death.vs.cases %>% pull(cases.confirmed))),
                          y = ceiling(max(death.vs.cases %>% pull(cases.death)))) +
            labs(x = 'Confirmed Cases per 100k population', 
                 y = 'Deaths per 100k population', 
                 title = 'Deaths vs. Cases per 100k population', 
                 subtitle = 'percentage is the death rate per confirmed cases and size represents size of country by population',
                 caption = last.date.string) +
            theme_minimal() +
            theme(legend.position = 'none'))
}
```

## All states

```{r eu, echo=FALSE}
plot.death.vs.cases(countries.extended)
```

## Data for Confirmed Cases

```{r death.vs.cases.data.confirmed, echo=FALSE}
my.corona.original %>%
    filter(country %in% countries.extended) %>%
    filter(type == 'confirmed') %>%
    group_by(country, type) %>%
    summarise(cases = sum(cases)) %>%
    arrange(cases) %>%
    ungroup() %>%
    mutate(country = paste0(country, ' (', cases, ')')) %>%
    mutate(country = factor(country, levels = unique(.$country))) %>%
    ggplot() +
        geom_bar(aes(country, cases, fill = country), stat = 'identity') +
        # scale_y_continuous(trans = 'log10') +
        coord_flip() +
        labs(x = 'Confirmed Cases', 
             y = '', 
             title = 'Confirmed Cases by Country' ,
             caption = last.date.string) + 
        theme_minimal() + 
        theme(legend.position = 'none')
```

## Data for Deaths

```{r death.vs.cases.data.death, echo=FALSE}
my.corona.original %>%
    filter(country %in% countries.extended) %>%
    filter(type == 'death') %>%
    group_by(country, type) %>%
    summarise(cases = sum(cases)) %>%
    arrange(cases) %>%
    ungroup() %>%
    mutate(country = paste0(country, ' (', cases, ')')) %>%
    mutate(country = factor(country, levels = unique(.$country))) %>%
    ggplot() +
        geom_bar(aes(country, cases, fill = country), stat = 'identity') +
        # scale_y_continuous(trans = 'log10') +
        coord_flip() +
        labs(x = 'Deaths', 
             y = '', 
             title = 'Deaths by Country' , 
             caption = last.date.string) + 
        theme_minimal() + 
        theme(legend.position = 'none')
```


