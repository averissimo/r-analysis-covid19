---
title: "Germany analysis of covid-19 cases"
output: 
    html_document:
        toc: true
        dev: 'svg'
params:
    death.start: !r 5
    confirmed.start: !r 100
    duplicate.every: !r 2
    last.days: !r 12
---

# Preface

This is a personal analysis of the cases of covid-19.

I'm not from the Epidemiology field. I'm currently working on modeling cancer datasets for my PhD thesis.

# Other covid-19 analysis

* [World](https://averissimo.github.io/covid19-analysis/)
* [Bavaria (in Germany)](https://averissimo.github.io/covid19-analysis/bayern.html)

```{r render.me, include=FALSE, eval=FALSE}
rmarkdown::render('Bavaria.Rmd', quiet = TRUE)
```

```{r render.site, include=FALSE, eval=FALSE}
rmarkdown::render_site(quiet = TRUE)
rmarkdown::render_site()
rmarkdown::clean_site()
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, fig.width = 10, fig.height = 8)
library(tidyverse)
library(dplyr)
library(viridis) # color pallete
library(ggrepel)
library(zoo)
library(glue)
library(DT)
library(anytime)
library(scales)
library(futile.logger)
library(wbstats) # world bank data
library(reshape2)
library(eurostat)

Sys.setlocale('LC_TIME', 'en_GB.UTF-8')
.Last.value <- flog.layout(layout.format('~m'))
```

# Data

Data was retrieved from *'RamiKrispin/coronavirus'* R data package which is updated daily in github.com.

It's not realtime data and data presented may have 1 or more days of difference from real-time data. Check the caption on the figures to check when was the last data point.


```{r buildCorona, echo=FALSE, message=FALSE, warning=FALSE}
eu.de.raw <- read_csv('https://github.com/covid19-eu-zh/covid19-eu-data/raw/master/dataset/covid-19-de.csv')

eu.de <- eu.de.raw %>%
    mutate(nuts_1 = gsub('[\u00ad]', '', nuts_1)) %>%
    filter(nuts_1 != 'Repatriierte') %>%
    select(state = nuts_1, cases, deaths, date = datetime) %>%
    group_by(state) %>% 
    melt(id.vars = c('state', 'date'), variable.name = 'type', value.name = 'cases') %>%
    mutate(type = if_else(type == 'cases', 'confirmed', 'death')) %>%
    arrange(desc(date)) %>%
    group_by(state, type) %>% 
    mutate(date = anydate(format(date, '%Y/%m/%d')),
           cumul = cases,
           # need to break down differences between days
           cases = rollapply(cases, 2, function(ix) { if(length(ix) <= 1) { return(ix) } else { ix[1] - sum(ix[-1]) } }, fill = c(0, 0, 0), align = 'left', partial = TRUE))

my.corona.original <- eu.de

source.by = 'Robert Koch Institute'
```


```{r summaryCorona, echo=FALSE, collapse=TRUE}
flog.info('### Summary of data ###')
flog.info('')
flog.info('     States: %d', my.corona.original %>% filter(cases > 0) %>% pull(state) %>% unique %>% length)
flog.info('')
flog.info('      Cases: %d', sum((my.corona.original %>% filter(type == 'confirmed'))$cases))
flog.info('     Deaths: %d', sum((my.corona.original %>% filter(type == 'death'))$cases))
flog.info('')

last.date <- format(max(my.corona.original$date), '%Y/%m/%d')
last.date.string <- paste0('Latest date from ', last.date, ' (source: ', source.by, ')')

flog.info('     Latest: %s from %s', last.date, source.by)
```


## States in visualizations

The plots presented get very complex as more states are added.

```{r, echo=FALSE, collapse=TRUE, include=TRUE}
countries <- my.corona.original %>% pull(state) %>% unique %>% sort

flog.info('Looking only at the following states: \n\n  %s' , paste0(countries, collapse = ', '))
```

# Top 30 states {.tabset .tabset-fade .tabset-pills}

## Total Confirmed cases

```{r top30confirmed, echo=FALSE}
top30(my.corona.original, 'confirmed')
```

## Total Deaths

```{r top30deaths, echo=FALSE}
top30(my.corona.original, 'confirmed')
```

## Data confirmed

```{r data.confirmed, echo=FALSE}
my.corona.original %>% top30.data('confirmed') %>% datatable
```

## Data death

```{r data.death, echo=FALSE}
my.corona.original %>% top30.data('death') %>% datatable
```

```{r eurostat}
populations <- download.eurostat.population('DE')

my.corona <- my.corona.original %>% left_join(populations, by = 'state')

my.corona <- my.corona %>% 
    ungroup %>%
    mutate(state.data = factor(state, levels = my.corona %>% filter(type == 'confirmed') %>% summarise(cases = max(cumul)) %>% arrange(cases) %>% pull(state)),
           state = state) %>%
    group_by(state)
```

```{r, echo=FALSE}
my.corona.after.100 <- filter.after(my.corona, params$death.start, params$confirmed.start)
```

# Confirmed cases / Deaths *(ommiting start of epidemic)*

## Starting point after exceeding `r params$confirmed.start` cases or `r params$death.start` deaths {.tabset .tabset-fade .tabset-pills}

The visualizations presented below have been time-shifted to the day when each state exceeded `r params$confirmed.start` cases or `r params$death.start` deaths *(depending on the visualization)*.

It is an arbitrary number, but allows to have a more accurate view of the progression as the first cases are quite sporadic and make the plots more complex.

**Important note**: All plots are in the logarithm scale *(base 2)* as it allows to better visualize when cases duplicate.

It is used because covid-19 cases grow very fast, and this way it becomes easier to read over time the number of cases. Always look at the y axis.

If you do not understand logarythm scale, I recommend this [video](https://www.youtube.com/watch?v=Kas0tIxDvrg).

### Confirmed cases  

```{r corfirmed.cases.after.100, echo=FALSE}
ommit.start(my.corona.after.100, 'confirmed', params$confirmed.start, filter.countries = countries)
```

### Patient deaths

```{r death.after.100, echo=FALSE}
ommit.start(my.corona.after.100, 'death', params$death.start, filter.countries = countries)
```

### Confirmed cases *(log2 scale)*

```{r, echo=FALSE}
ommit.start(my.corona.after.100, 'confirmed', params$confirmer.start, filter.countries = countries, log2.flag = TRUE)
```

### Patient deaths *(log2 scale)*

```{r, echo=FALSE}
ommit.start(my.corona.after.100, 'death', params$death.start, filter.countries = countries, log2.flag = TRUE)
```

### Data for confirmed cases

```{r confirmed.per.100.data.1, echo=FALSE}
my.corona.after.100.confirmed.dat <- ommit.data(my.corona.after.100, 'confirmed', countries)
my.corona.after.100.confirmed.dat %>% datatable
```

### Data for deaths

```{r deaths.per.100.data.1, echo=FALSE}
my.corona.after.100.death.dat <- ommit.data(my.corona.after.100, 'death', countries)
my.corona.after.100.death.dat %>% datatable()
```

## Starting point after exceeding `r params$confirmed.start` cases or `r params$death.start` deaths *(per 100k population)* {.tabset .tabset-fade .tabset-pills}

Showing population for plotted states. This becomes relevant for the next plots.

### Confirmed cases

```{r confirmed.after.100.per100k, echo=FALSE}
ommit.start(my.corona.after.100, 'confirmed', params$confirmed.start, filter.countries = countries, log2.flag = FALSE, per.100k.flag = TRUE)
```

### Deaths 

```{r death.after.100.per.100k, echo=FALSE}
ommit.start(my.corona.after.100, 'death', params$confirmer.start, filter.countries = countries, log2.flag = FALSE, per.100k.flag = TRUE)
```

### Confirmed cases *(log2 scale)*

```{r, echo=FALSE}
ommit.start(my.corona.after.100, 'confirmed', params$confirmer.start, filter.countries = countries, log2.flag = TRUE, per.100k.flag = TRUE)
```

### Deaths *(log2 scale)*

```{r, echo=FALSE}
ommit.start(my.corona.after.100, 'death', params$confirmer.start, filter.countries = countries, log2.flag = TRUE, per.100k.flag = TRUE)
```

### Data for confirmed cases

```{r confirmed.per.100.data, echo=FALSE}
my.corona.after.100.confirmed.dat %>% datatable
```

### Data for deaths

```{r deaths.per.100.data, echo=FALSE}
my.corona.after.100.death.dat %>% datatable
```

### Population data

```{r population.data, echo=FALSE}
population.data(my.corona) %>% datatable()
```

# Last `r params$last.days` days {.tabset .tabset-fade .tabset-pills}

Instead of showing the evolution of the cases/deaths since a state exceeded `r params$confirmed.start`/`r params$death.start` cases, it insteads shows the last 12 days.

The first data point is the number of new cases that day.

## Confirmed cases 

```{r confirmed.last12.days, echo=FALSE}
my.corona.last.days <- filter.last.days(my.corona, params$last.days)
last.days(my.corona.last.days, 'confirmed', params$last.days, countries, log2.flag = FALSE, per.100k.flag = FALSE)
```

## Deaths

```{r death.last12.days, echo=FALSE, warning=FALSE}
last.days(my.corona.last.days, 'death', params$last.days, countries, log2.flag = FALSE, per.100k.flag = FALSE)
```

## Confirmed cases *(log2 scale)*

```{r, echo=FALSE, message=FALSE, warning=FALSE}
last.days(my.corona.last.days, 'confirmed', params$last.days, countries, log2.flag = TRUE, per.100k.flag = FALSE)
```

## Deaths

```{r, echo=FALSE, warning=FALSE}
last.days(my.corona.last.days, 'death', params$last.days, countries, log2.flag = FALSE, per.100k.flag = FALSE)
```

## Data for confirmed cases

**warning**: sub-total is only for last 12 days

```{r last.12.days.confirmed.data, echo=FALSE}
last.days.data(my.corona.last.days, 'confirmed', countries) %>% datatable
```

## Data for Deaths

**warning**: sub-total is only for last 12 days

```{r last.12.days.death.data, echo=FALSE}
last.days.data(my.corona.last.days, 'death', countries) %>% datatable
```

# Cumulative cases of previous 4 days *(how it tracks over time)* {.tabset .tabset-fade .tabset-pills}

**Warning**: This visualization is not very intuitive, use it to see the trend over the last days.

```{r countries.more, echo=FALSE}
countries.always.include <- c()

countries.extended <- countries

# countries.extended[!countries.extended %in% my.corona$state]
# countries.extended[!countries.extended %in% populations$state]

# my.corona$state %>% unique %>% sort
# populations$state %>% unique %>% sort

last.week <- filter.last.days.cumulative(my.corona.original, populations, 4)
```

## Confirmed cases

```{r confirmed.lastweek.cumulative, echo=FALSE}
last.week.cumulative(last.week, 'confirmed', 4, countries, log2.flag = FALSE, per.100k.flag = FALSE)
```

## Deaths

```{r death.lastweek.cumulative, echo=FALSE}
last.week.cumulative(last.week, 'death', 4, countries, log2.flag = FALSE, per.100k.flag = FALSE)
```

## Confirmed cases

```{r confirmed.lastweek.cumulative, echo=FALSE}
last.week.cumulative(last.week, 'confirmed', 4, countries, log2.flag = FALSE, per.100k.flag = TRUE)
```

## Deaths

```{r death.lastweek.cumulative, echo=FALSE}
last.week.cumulative(last.week, 'death', 4, countries, log2.flag = FALSE, per.100k.flag = TRUE)
```
## Data for Confirmed cases in last 4 days

```{r data.last.week, echo=FALSE}
cumulative.last.days.data(last.week, 'confirmed', countries, 4) %>% datatable()
```

## Data for Deaths in last 4 days

```{r data.last.week, echo=FALSE}
cumulative.last.days.data(last.week, 'death', countries, 4) %>% datatable()
```

# Confirmed cases vs. Death visualizations *(per 100k population)* {.tabset .tabset-fade .tabset-pills}

This visualization shows the number of cases/deaths per 100k of the population.

* **x axis**: Confirmed cases per 100k population
* **y axis**: Deaths per 100k population
* **size of data point**: Total population if the state
* **label**: Rate of deaths per confirmed cases

```{r death.vs.cases.function.and.data, echo=FALSE}
death.vs.cases <- filter.death.vs.cases(last.week)
```

## All states

```{r eu, echo=FALSE}
death.vs.cases.plot(death.vs.cases)
```

## Data

```{r cases.vs.death.data, echo=FALSE}
death.vs.cases %>% death.vs.cases.data %>% datatable()
```

## Number of Confirmed Cases

```{r death.vs.cases.data.confirmed, echo=FALSE}
cases.plot(my.corona.original, 'confirmed')
```

## Number of Deaths

```{r death.vs.cases.data.death, echo=FALSE}
cases.plot(my.corona.original, 'death')
```


