---
title: "World covid-19 Analysis"
output: 
    html_document:
        toc: true
        dev: 'svg'
params:
    death.start: !r 10
    confirmed.start: !r 100
    duplicate.every: !r 2
    last.days: !r 12
---

# Preface

This is a personal analysis of the cases of covid-19.

I'm not from the Epidemiology field. My background is computer science and bioinformatics.

## Other covid-19 analysis

* [Germany (by state)](https://averissimo.github.io/covid19-analysis/germany.html)
* [Italy (by regione)](https://averissimo.github.io/covid19-analysis/italy.html)
* [Bavaria (in Germany)](https://averissimo.github.io/covid19-analysis/bayer.html)

## Symptoms *(count)* for Portugal

1. Headaches - Cefaleias - Dor de cabeça - 2233
1. Cough - Tosse - 1878
1. Fever - Febre - 1701
1. General weakness - Fraqueza generalizada - 1311
1. Muscular pain - Dores musculares - 1099
1. Difficulties breathing - Dificuldade Respiratória - 673

```{r, include=FALSE, eval=FALSE}
rmarkdown::render('index.Rmd', quiet = TRUE)
```

```{r, include=FALSE, eval=FALSE}
rmarkdown::render_site(quiet = TRUE)
rmarkdown::render_site()
rmarkdown::clean_site()
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, collapse = TRUE, fig.width = 10, fig.height = 8)
library(tidyverse)
library(dplyr)
library(viridis) # color pallete
library(ggrepel)
library(zoo)
library(glue)
library(DT)
library(loose.rock)
library(anytime)
library(scales)
library(futile.logger)
library(wbstats) # world bank data
library(reshape2)
library(eurostat)

devtools::load_all()

Sys.setlocale('LC_TIME', 'en_GB.UTF-8')
.Last.value <- flog.layout(layout.format('~m'))
```

# Data

Data was retrieved from *'RamiKrispin/coronavirus'* R data package which is updated daily in github.com.

It's not realtime data and data presented may have 1 or more days of difference from real-time data. Check the caption on the figures to check when was the last data point.

```{r, message=FALSE, warning=FALSE}
BiocManager::install('RamiKrispin/coronavirus', ask = FALSE)

library(coronavirus)

world.dat <- download.world.data()

it.dat <- download.it.data() 

source.by <- '{world.dat$source} and {it.dat$source}'

it.dat <- it.dat$data %>%
    ungroup %>%
    mutate(state = 'Italy') %>%
    group_by(state, date, type) %>%
    summarise(cases = sum(cases),
              cumul = sum(cumul)) %>% 
    ungroup() %>%
    arrange(date)

my.corona.original <- world.dat$data %>% 
    filter(state != 'Diamond Princess') %>%
    filter(state != 'Italy') %>%
    ungroup() %>%
    add_row(state = it.dat$state, type = it.dat$type, date = it.dat$date, cases = it.dat$cases, cumul = it.dat$cumul) %>%
    arrange(date, state, type) %>%
    group_by(state, type)
```

```{r}
### Add census data from World Bank
#
# Population census data from World Bank
#
# Get data from world bank
convert.names <- list('United States' = 'US',
                      'Czech Republic' = 'Czechia',
                      'Russian Federation' = 'Russia',
                      'Slovak Republic' = 'Slovakia',
                      'Korea, Rep.' = 'Korea, South',
                      'Iran, Islamic Rep.' = 'Iran',
                      'Brunei Darussalam' = 'Brunei',
                      'Egypt, Arab Rep.' = 'Egypt',
                      'Bahamas, The' = 'Bahamas',
                      'Congo, Rep.' = 'Congo (Brazzaville)',
                      'Congo, Dem. Rep.' = 'Congo (Kinshasa)',
                      'Gambia, The' = 'Gambia',
                      'Kyrgyz Republic' = 'Kyrgyzstan',
                      'Lao PDR' = 'Laos',
                      'St. Kitts and Nevis' = 'Saint Kitts and Nevis',
                      'St. Lucia' = 'Saint Lucia',
                      'St. Vincent and the Grenadines' = 'Saint Vincent and the Grenadines',
                      'Syrian Arab Republic' = 'Syria',
                      'Venezuela, RB' = 'Venezuela')

populations <- run.cache(wb, indicator = "SP.POP.TOTL", show.message = FALSE) %>% 
    group_by(iso3c) %>%
    filter(date == max(date)) %>%
    select(population = value, state = country, iso3c) %>%
    ungroup() %>%
    #
    add_row(state = 'Diamond Princess', population = 3711) %>%
    add_row(state = 'Taiwan*', population = 23603121) %>%
    add_row(state = 'Holy See', population = 801) %>%
    arrange(state)
     
# Change some country name to match covid-19 data
for (ix.name in names(convert.names)) {
    populations <- populations %>%
        arrange(state) %>%
        ungroup %>%
        mutate(state = replace(state, state == ix.name, convert.names[[ix.name]]))    
}

# populations$state[!populations$state %in% my.corona.original$state]
# populations$state %>% unique %>% sort

my.corona <- my.corona.original %>% left_join(populations, by = 'state')

my.corona <- mutate(my.corona, 
                    state.data = factor(state, 
                                        levels = my.corona %>% filter(type == 'confirmed') %>% summarise(cases = max(cumul)) %>% arrange(cases) %>% pull(state))) %>%
    select(-iso3c)
```


```{r}
last.date          <- format(max(my.corona.original$date), '%Y/%m/%d')
last.date.string   <- paste0('Latest date from ', last.date, ' (source: ', source.by, ')')
region.code        <- 'Country'
region.code.plural <- 'Countries'

countries          <- c('Italy', 'Spain','Germany', 'China', 'Portugal', 'US', 'France', 'Switzerland', 'Iran') %>% sort

countries.eu <- c('Italy', 'Spain','Germany', 'Portugal', 'France',  
                  'United Kingdom', 'Poland', 'Greece', 'Croatia', 'Slovenia', 
                  'Hungary', 'Slovakia', 'Ireland', 'Luxembourg', 'Finland', 
                  'Sweden', 'Denmark', 'Romania', 'Netherlands', 'Belgium', 
                  'Czechia', 'Austria', 'Bulgaria', 'Lithuania', 'Latvia', 
                  'Malta', 'Estonia', 'Cyprus')
countries.cplp <- c('Angola', 'Mozambique', 'Cabo Verde', 'Timor-Leste', 
                    'Brazil'
                    , 'Macao SAR, China', 'Guinea-Bissau', 'Sao Tome and Principe' # not in corona data
                    )
countries.europe.non.eu <- c('Norway', 'Switzerland', 'Ukraine', 'Serbia', 'Russia', 
                             'Albania', 'Iceland', 'Turkey', 'Belarus')
countries.non.europe <- c('US', 'China', 'Canada', 
                          'Australia', 'New Zealand', 
                          'Korea, South', 'Japan', 'Argentina', 'Chile', 'Thailand',
                          'Iran')

countries.always.include <- c('Portugal', 'Iran', 'Germany', 'Spain', 'Italy', 'Korea, South')
countries.extended <- c(countries.eu, countries.europe.non.eu, countries.cplp, countries.non.europe, countries.always.include) %>%
    unique
```


```{r, collapse=TRUE}
flog.info('### Summary of data ###')
flog.info('')
flog.info('  %s: %d', region(2), my.corona.original %>% filter(cases > 0) %>% pull(state) %>% unique %>% length)
flog.info('')
flog.info('      Cases: %d', sum((my.corona.original %>% filter(type == 'confirmed'))$cases))
flog.info('     Deaths: %d', sum((my.corona.original %>% filter(type == 'death'))$cases))
flog.info('')
flog.info('     Latest: %s from %s', last.date, source.by)
```


## Main `r region(2)` in visualizations

The plots presented get very complex as more `r region(2, TRUE)` are added. I'm focusing mainly on Europe and comparing against Portugal and Germany *(where I'm from vs. where I live)*

```{r, collapse=TRUE}
flog.info('Looking only at the following %s: \n\n  %s' , region(2, TRUE), paste0(countries, collapse = ', '))
```

# Top 30 `r region(2)` {.tabset .tabset-fade .tabset-pills}

## Total Cases

```{r, message=FALSE}
top30(my.corona.original, 'confirmed')
```

## Total Deaths

```{r, message=FALSE}
top30(my.corona.original, 'death')
```

## Data Cases

```{r}
my.corona.original %>% top30.data('confirmed') %>% datatable
```

## Data Deaths

```{r}
my.corona.original %>% top30.data('death') %>% datatable
```

```{r}
my.corona.after.100 <- filter.after(my.corona, params$death.start, params$confirmed.start)
```

# Confirmed cases / Deaths {.tabset .tabset-fade .tabset-pills}

## Confirmed

```{r}
ommit.start(my.corona, 'confirmed', params$confirmed.start, filter.states = countries)
```

## Deaths

```{r}
ommit.start(my.corona, 'death', params$confirmed.start, filter.states = countries)
```

## Confirmed *(log2 scale)*

```{r}
ommit.start(my.corona, 'confirmed', params$confirmed.start, filter.states = countries, log2.flag = TRUE)
```

## Deaths *(log2 scale)*

```{r}
ommit.start(my.corona, 'death', params$confirmed.start, filter.states = countries, log2.flag = TRUE)
```

## Data for Confirmed

```{r}
ommit.data(my.corona, 'confirmed') %>% datatable
```

## Data for Deaths

```{r}
ommit.data(my.corona, 'confirmed') %>% datatable
```

# Confirmed cases / Deaths *(ommiting early start of epidemic)*

## Starting point after exceeding `r params$confirmed.start` cases or `r params$death.start` deaths {.tabset .tabset-fade .tabset-pills}

The visualizations presented below have been time-shifted to the day when each `r region(1, TRUE)` exceeded `r params$confirmed.start` cases or `r params$death.start` deaths *(depending on the visualization)*.

It is an arbitrary number, but allows to have a more accurate view of the progression as the first cases are quite sporadic and make the plots more complex.

**Important note**: All plots are in the logarithm scale *(base 2)* as it allows to better visualize when cases duplicate.

It is used because covid-19 cases grow very fast, and this way it becomes easier to read over time the number of cases. Always look at the y axis.

If you do not understand logarythm scale, I recommend this [video](https://www.youtube.com/watch?v=Kas0tIxDvrg).

### Cases  

```{r}
ommit.start(my.corona.after.100, 'confirmed', params$confirmed.start, filter.states = countries)
```

### Deaths

```{r}
ommit.start(my.corona.after.100, 'death', params$death.start, filter.states = countries)
```

### Cases *(log2 scale)*

```{r}
ommit.start(my.corona.after.100, 'confirmed', params$confirmer.start, filter.states = countries, log2.flag = TRUE)
```

### Deaths *(log2 scale)*

```{r}
ommit.start(my.corona.after.100, 'death', params$death.start, filter.states = countries, log2.flag = TRUE)
```

### Data for Cases

```{r}
my.corona.after.100.confirmed.dat <- ommit.data(my.corona.after.100, 'confirmed', countries)
my.corona.after.100.confirmed.dat %>% datatable
```

### Data for Deaths

```{r}
my.corona.after.100.death.dat <- ommit.data(my.corona.after.100, 'death', countries)
my.corona.after.100.death.dat %>% datatable()
```

## Starting point after exceeding `r params$confirmed.start` cases or `r params$death.start` deaths *(per 100k population)* {.tabset .tabset-fade .tabset-pills}

Showing population for plotted `r region(2, TRUE)` This becomes relevant for the next plots.

### Cases

```{r}
ommit.start(my.corona.after.100, 'confirmed', params$confirmed.start, filter.states = countries, log2.flag = FALSE, per.100k.flag = TRUE)
```

### Deaths 

```{r}
ommit.start(my.corona.after.100, 'death', params$confirmer.start, filter.states = countries, log2.flag = FALSE, per.100k.flag = TRUE)
```

### Cases *(log2 scale)*

```{r}
ommit.start(my.corona.after.100, 'confirmed', params$confirmer.start, filter.states = countries, log2.flag = TRUE, per.100k.flag = TRUE)
```

### Deaths *(log2 scale)*

```{r}
ommit.start(my.corona.after.100, 'death', params$confirmer.start, filter.states = countries, log2.flag = TRUE, per.100k.flag = TRUE)
```

### Data for Cases

```{r}
my.corona.after.100.confirmed.dat %>% datatable
```

### Data for Deaths

```{r}
my.corona.after.100.death.dat %>% datatable
```

# Last `r params$last.days` days {.tabset .tabset-fade .tabset-pills}

Instead of showing the evolution of the cases/deaths since a `r region(1, TRUE)` exceeded `r params$confirmed.start`/`r params$death.start` cases, it insteads shows the last 12 days.

The first data point is the number of new cases that day.

## Cases 

```{r}
my.corona.last.days <- filter.last.days(my.corona, params$last.days)
last.days(my.corona.last.days, 'confirmed', params$last.days, countries, log2.flag = FALSE, per.100k.flag = FALSE)
```

## Deaths

```{r, warning=FALSE}
last.days(my.corona.last.days, 'death', params$last.days, countries, log2.flag = FALSE, per.100k.flag = FALSE)
```

## Cases *(log2 scale)*

```{r, message=FALSE, warning=FALSE}
last.days(my.corona.last.days, 'confirmed', params$last.days, countries, log2.flag = TRUE, per.100k.flag = FALSE)
```

## Deaths

```{r, warning=FALSE}
last.days(my.corona.last.days, 'death', params$last.days, countries, log2.flag = FALSE, per.100k.flag = FALSE)
```

## Data for Cases

**warning**: sub-total is only for last 12 days

```{r}
last.days.data(my.corona.last.days, 'confirmed', countries) %>% datatable
```

## Data for Deaths

**warning**: sub-total is only for last 12 days

```{r}
last.days.data(my.corona.last.days, 'death', countries) %>% datatable
```

# Sum of previous 4 days *(tracking over time)* {.tabset .tabset-fade .tabset-pills}

**Warning**: This visualization is not very intuitive, use it to see the trend over the last days.

```{r}
last.week <- filter.last.days.cumulative(my.corona.original, populations, 4)
```

## Cases

```{r}
last.week.cumulative(last.week, 'confirmed', 4, countries, log2.flag = FALSE, per.100k.flag = FALSE)
```

## Deaths

```{r}
last.week.cumulative(last.week, 'death', 4, countries, log2.flag = FALSE, per.100k.flag = FALSE)
```

## Cases *(per 100k population)*

```{r}
last.week.cumulative(last.week, 'confirmed', 4, countries, log2.flag = FALSE, per.100k.flag = TRUE)
```

## Deaths *(per 100k population)*

```{r}
last.week.cumulative(last.week, 'death', 4, countries, log2.flag = FALSE, per.100k.flag = TRUE)
```

## Data for Cases in last 4 days

```{r}
cumulative.last.days.data(last.week, 'confirmed', countries, 4) %>% datatable()
```

## Data for Deaths in last 4 days

```{r}
cumulative.last.days.data(last.week, 'death', countries, 4) %>% datatable()
```

# Cases vs. Death visualizations *(per 100k population)* {.tabset .tabset-fade .tabset-pills}

This visualization shows the number of cases/deaths per 100k of the population.

* **x axis**: Confirmed cases per 100k population
* **y axis**: Deaths per 100k population
* **size of data point**: Total population of the `r region(1, TRUE)`
* **label**: Rate of deaths per confirmed cases

```{r}
death.vs.cases <- filter.death.vs.cases(last.week) %>% filter(state %in% countries.extended)
```

## EU

```{r}
death.vs.cases.plot(death.vs.cases, state.filter = countries.eu, always.include = countries.always.include)
```

## Non-EU Europe

```{r}
death.vs.cases.plot(death.vs.cases, state.filter = countries.europe.non.eu, always.include = countries.always.include)
```

## Non-Europe

```{r}
death.vs.cases.plot(death.vs.cases, state.filter = countries.non.europe, always.include = countries.always.include)
```

## CPLP

```{r}
death.vs.cases.plot(death.vs.cases, state.filter = countries.cplp, always.include = countries.always.include)
```

## Data

```{r}
death.vs.cases.data(death.vs.cases) %>% datatable()
```

## Number of Confirmed Cases

```{r}
my.corona.original %>% filter(state %in% countries.extended) %>% cases.plot('confirmed')
```

## Number of Deaths

```{r}
my.corona.original %>% filter(state %in% countries.extended) %>% cases.plot('death')
```

# Hospital beds vs. Cases *(per 100k population)* {.tabset .tabset-fade .tabset-pills}

This visualization shows the number of cases/deaths per 100k of the population.

* **x axis**: Confirmed cases per 100k population
* **y axis**: Hospital beds per 100k population
* **size of data point**: Ratio of Confirmed cases / Hospital beds
* **label**: `r region(1)` (<Confirmed cases / Hospital beds> | <Deaths / Hospital beds>)

*note*: It always shows Portugal, Spain, Italy, South Korea, Iran and Germany.

```{r}
beds.vs.cases <- wb.indicator(death.vs.cases, 'SH.MED.BEDS.ZS', 'Hospital beds')
```

```{r}
plot.beds.vs.cases <- function(...) { 
    plot.what.vs.cases(..., 
                       data = beds.vs.cases, 
                       what = 'Hospital beds', 
                       always.include = countries.always.include)
}
```

## EU

```{r}
plot.beds.vs.cases(countries.eu)
```

## Non-EU Europe

```{r}
plot.beds.vs.cases(countries.europe.non.eu)
```

## Non-Europe

```{r}
plot.beds.vs.cases(countries.non.europe)
```

## CPLP

```{r}
plot.beds.vs.cases(countries.cplp)
```

## Data

```{r}
something.vs.cases.data(beds.vs.cases, 'Beds') %>% datatable()
```

# Nurses and Midwifes *(per 100k population)*  {.tabset .tabset-fade .tabset-pills}

```{r}
nurses.vs.cases <- wb.indicator(death.vs.cases, 'SH.MED.NUMW.P3', 'Nurses and midwives')
```

```{r}
plot.nurses.vs.cases <- function(...) { plot.what.vs.cases(..., data = nurses.vs.cases, what = 'Nurses and Midwifes') }
```

## EU

```{r}
plot.nurses.vs.cases(countries.eu)
```

## Non-EU Europe

```{r}
plot.nurses.vs.cases(countries.europe.non.eu)
```

## Non-Europe

```{r}
plot.nurses.vs.cases(countries.non.europe)
```

## CPLP

```{r}
plot.nurses.vs.cases(countries.cplp)
```


## Data

```{r}
something.vs.cases.data(nurses.vs.cases, 'Nurses') %>% datatable()
```

# Physicians *(per 100k population)*  {.tabset .tabset-fade .tabset-pills}


```{r}
physicians.vs.cases <- wb.indicator(death.vs.cases, 'SH.MED.PHYS.ZS', 'Physicians')
```

```{r}
plot.physicians.vs.cases <- function(...) { plot.what.vs.cases(..., data = physicians.vs.cases, what = 'Physicians') }
```

## EU

```{r}
plot.physicians.vs.cases(countries.eu)
```

## Non-EU Europe

```{r}
plot.physicians.vs.cases(countries.europe.non.eu)
```

## Non-Europe

```{r}
plot.physicians.vs.cases(countries.non.europe)
```

## CPLP

```{r}
plot.physicians.vs.cases(countries.cplp)
```

## Data

```{r}
something.vs.cases.data(physicians.vs.cases, 'Nurses') %>% datatable()
```


\- - - - - - - - The end. - - - - - - - -

```{r, eval=FALSE, include=FALSE}
anim.confirmed.vs.death <- last.week %>%
    filter(country %in% c('Italy', 'Portugal')) %>%
    group_by(country, date) %>%
    mutate(cases.death = cumulative.cases.death / population * 100000,
           cases.confirmed = cumulative.cases.confirmed / population * 100000,
           ratio = if_else(cumulative.cases.confirmed == 0, 0, cumulative.cases.death / cumulative.cases.confirmed)) %>%
    select(country, date, cases.confirmed, cases.death, cumul.confirmed = cumulative.cases.confirmed, cumul.death = cumulative.cases.death, ratio, population) %>%
    arrange(desc(date))

anim.confirmed.vs.death
```

```{r, eval=FALSE, include=FALSE}
anim <- anim.confirmed.vs.death %>%
    arrange(date) %>%
    #filter(date == '2020-03-24') %>%
    ggplot(aes(x = cases.confirmed, y = cases.death, color = country)) +
        geom_point(aes(size = population), alpha = .4) +
        geom_label_repel(aes(label = paste0(country, ' (', percent(ratio, accuracy = .1), ')'),
                     fill = country),
                     na.rm = TRUE,
                     alpha = .8,
                     color = 'white',
                     size = 3,
                     segment.alpha = .4,
                     segment.colour = 'black',
                     force = 2) +
        expand_limits(x = ceiling(max(anim.confirmed.vs.death %>% pull(cases.confirmed))),
                          y = ceiling(max(anim.confirmed.vs.death %>% pull(cases.death)))) +
            labs(x = 'Confirmed Cases per 100k population', 
                 y = 'Deaths per 100k population', 
                 title = 'Deaths vs. Cases per 100k population -- {format(frame_along, \'%B\ %d\')}', 
                 subtitle = 'percentage is the death rate per confirmed cases and size represents size of {region(1, TRUE)} by population' %>% glue,
                 caption = '??') +
            theme_minimal() +
            theme(legend.position = 'none') +
    transition_time(date) +
    enter_drift()
```

```{r, message=FALSE, eval=FALSE, include=FALSE}
animate(anim, end_pause = 30)
```
