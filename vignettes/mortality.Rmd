---
title: "Portugal Mortality data"
output: 
  html_document:
    dev: 'svg'
---

```{r, eval=FALSE, include=FALSE}
rmarkdown::render('mortality.Rmd', output_file = 'mortality.md')
rmarkdown::render('mortality.Rmd', output_file = 'mortality.html')
```

```{r, eval=FALSE, include=FALSE}
rmarkdown::clean_site()
rmarkdown::render_site(quiet = TRUE)
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = FALSE,
  comment = "#>",
  fig.height = 10,
  fig.width = 10
)
devtools::load_all()
library(pdftools)
library(rvest)
library(dplyr)
library(tibble)
library(DT)
library(anytime)
library(glue)
library(reshape2)
library(zoo)
library(xml2)
library(ggplot2)
library(ggrepel)
library(plotly)

Sys.setlocale('LC_TIME', 'en_GB.UTF-8')
```

## Description & Code {.tabset .tabset-fade .tabset-pills}

This analysis retrieves data directly from the Portuguese Health ministry death certificate site ([SICO](https://evm.min-saude.pt/)) and makes an yearly comparison.

### Hide source code


### Show source code

```{r, echo=TRUE}
# Download from DGS
json <- download.evm() %>% rjson::fromJSON()

# Process into multiple columns
dat <- sapply(1 + seq_along(json$x$data[-1]), function(ix) {
  my.year <- json$x$data[[ix]]
  my.year[sapply(my.year, is.null)] <- NA
  tibble::tibble(!!as.name(2009 + ix - 2) := unlist(my.year, recursive=FALSE))
})

# Merge data
mortality <- dplyr::bind_cols(day = json$x$data[[1]], dat) %>% 
  mutate(day = factor(day, levels = day))

# Add some statistics (mean, sd, max, min)
mortality.with.stats <- mortality %>% 
  replace(is.na(.), NA) %>%
  dplyr::rowwise() %>% 
  mutate(meanPre2020 = mean(c_across(cols = -c("2020", 'day')), na.rm = TRUE),
         mean = mean(c_across(cols = -c("meanPre2020", 'day')), na.rm = TRUE),
         sdPre2020 = sd(c_across(cols = -c("2020","meanPre2020", "mean", 'day')), na.rm = TRUE),
         sd = sd(c_across(cols = -c("meanPre2020", "mean", "sdPre2020", 'day')), na.rm = TRUE)) %>% 
  mutate(maxPre2020 = max(c_across(cols = colnames(.)[colnames(mortality) != 2020][grepl('^[0-9]+$', colnames(.))]), na.rm = TRUE),
         max = max(c_across(cols = colnames(.)[grepl('^[0-9]+$', colnames(.))]), na.rm = TRUE),
         minPre2020 = min(c_across(cols = colnames(.)[colnames(mortality) != 2020][grepl('^[0-9]+$', colnames(.))]), na.rm = TRUE),
         min = min(c_across(cols = colnames(.)[grepl('^[0-9]+$', colnames(.))]), na.rm = TRUE)) %>% 
  dplyr::ungroup()
```

```{r sample_plot, eval=FALSE, echo=TRUE}
show.year.mortality(mortality.with.stats, seq(2019, 2020))
```


## Year vs. 2020 {.tabset .tabset-fade .tabset-pills}

Yearly comparison against 2020

### 2019 vs. 2020

```{r y2019}
show.year.mortality(mortality.with.stats, seq(2019, 2020))
```

### 2018 vs. 2020

```{r y2018}
show.year.mortality(mortality.with.stats, c(2018, 2020))
```

### 2017 vs. 2020

```{r y2017}
show.year.mortality(mortality.with.stats, c(2017, 2020))
```

### 2016 vs. 2020

```{r y2016}
show.year.mortality(mortality.with.stats, c(2016, 2020))
```

### 2015 vs. 2020

```{r y2015}
show.year.mortality(mortality.with.stats, c(2015, 2020))
```

### 2014 vs. 2020

```{r y2014}
show.year.mortality(mortality.with.stats, c(2014, 2020))
```

### 2013 vs. 2020

```{r y2013}
show.year.mortality(mortality.with.stats, c(2013, 2020))
```

### 2012 vs. 2020

```{r y2012}
show.year.mortality(mortality.with.stats, c(2012, 2020))
```

### 2011 vs. 2020

```{r y2011}
show.year.mortality(mortality.with.stats, c(2011, 2020))
```

### 2010 vs. 2020

```{r y2010}
show.year.mortality(mortality.with.stats, c(2010, 2020))
```

### 2009 vs. 2020

```{r y2009}
show.year.mortality(mortality.with.stats, c(2009, 2020))
```


## _'March-15 -> Now'_ yearly comparison {.tabset .tabset-fade .tabset-pills}

```{r}
yearly.stats <- mortality[c(rep(0, which(mortality$day == 'Mar-15') - 1), seq(from = which(mortality$day == 'Mar-15'), nrow(mortality)) > 0) & as.vector(!is.na(mortality[,'2020'])),] %>% 
  rowwise() %>% 
  replace(is.na(.), NA) %>%
  #mutate(maxPre2020    = max(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE),
  #       minPre2020    = min(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE),
  #       meanPre2020   = mean(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE),
  #       medianPre2020 = median(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE)) %>% 
  reshape2::melt(id.vars = 'day') %>% 
  dplyr::group_by(variable) %>% 
  dplyr::summarise(mean = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE),
            sum = sum(value, na.rm = TRUE),
            median = median(value, na.rm = TRUE),
            max = max(value, na.rm = TRUE),
            min = min(value, na.rm = TRUE),
            .groups = 'rowwise')
```


### Total numbers

```{r}
yearly.comp <- sapply(seq(nrow(yearly.stats)), function(ix) { yearly.stats$sum - yearly.stats$sum[ix]}) %>%
  data.frame()
yearly.comp[upper.tri(yearly.comp)] <- NA
colnames(yearly.comp) <- yearly.stats$variable
yearly.comp <- bind_cols(year = yearly.stats$variable, yearly.comp)

show.mortality.comp(yearly.comp) +
  labs(title = 'Absolute comparison between years')
```

### Relative numbers _(in percentage)_

```{r}
yearly.comp.rel <- sapply(seq(nrow(yearly.stats)), function(ix) { yearly.stats$sum / yearly.stats$sum[ix]}) %>%
  data.frame()
yearly.comp.rel[upper.tri(yearly.comp.rel)] <- NA
colnames(yearly.comp.rel) <- yearly.stats$variable
yearly.comp.rel <- bind_cols(year = yearly.stats$variable, yearly.comp.rel)

show.mortality.comp(yearly.comp.rel, is.percentage = TRUE) +
  labs(title = 'Relative comparison between years')
```

## _'March-15 -> Now'_ yearly comparisons with 2009-2019 stats {.tabset .tabset-fade .tabset-pills}

```{r}
yearly.stats.2 <- mortality[c(rep(0, which(mortality$day == 'Mar-15') - 1), seq(from = which(mortality$day == 'Mar-15'), nrow(mortality)) > 0) & as.vector(!is.na(mortality[,'2020'])),] %>% 
  rowwise() %>% 
  replace(is.na(.), NA) %>%
  mutate(maxPre2020    = max(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE),
         minPre2020    = min(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE),
         meanPre2020   = mean(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE),
         meanPlusStDevPre2020   = mean(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE) + sd(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE),
         meanMinusStDevPre2020   = mean(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE) - sd(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE),
         medianPre2020 = median(c_across(colnames(.)[!grepl('(^2020)',colnames(.)) & grepl('^[0-9]+$',colnames(.))]), na.rm = TRUE)) %>% 
  reshape2::melt(id.vars = 'day') %>% 
  dplyr::group_by(variable) %>% 
  dplyr::summarise(mean = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE),
            sum = sum(value, na.rm = TRUE),
            median = median(value, na.rm = TRUE),
            max = max(value, na.rm = TRUE),
            min = min(value, na.rm = TRUE),
            .groups = 'rowwise') %>% 
  filter(grepl('202[0-9]$', variable)) %>% 
  mutate(variable = factor(variable, levels = c( 'medianPre2020', 'minPre2020', 'meanMinusStDevPre2020', 'meanPre2020', 'meanPlusStDevPre2020', 'maxPre2020', '2020'))) %>% 
  arrange(variable)
```

### Total numbers

```{r}
yearly.comp.2 <- sapply(seq(nrow(yearly.stats.2)), function(ix) { yearly.stats.2$sum - yearly.stats.2$sum[ix]}) %>%
  data.frame()
yearly.comp.2[upper.tri(yearly.comp.2)] <- NA
colnames(yearly.comp.2) <- yearly.stats.2$variable
yearly.comp.2 <- bind_cols(year = yearly.stats.2$variable, yearly.comp.2)


show.mortality.comp(yearly.comp.2) +
  labs(title = 'Absolute comparison between pseudo-years', caption = 'Max/min/mean/median are calculated day by day in period 2009-2019 (for example, Max is the worse case scenario from that period)') + 
  theme(axis.text.x = element_text(angle = 45, hjust = 0))
```

### Relative numbers _(in percentage)_

```{r}
yearly.comp.rel.2 <- sapply(seq(nrow(yearly.stats.2)), function(ix) { yearly.stats.2$sum / yearly.stats.2$sum[ix]}) %>%
  data.frame()
yearly.comp.rel.2[upper.tri(yearly.comp.rel.2)] <- NA
colnames(yearly.comp.rel.2) <- yearly.stats.2$variable
yearly.comp.rel.2 <- bind_cols(year = yearly.stats.2$variable, yearly.comp.rel.2)

show.mortality.comp(yearly.comp.rel.2, is.percentage = TRUE) +
  labs(title = 'Relative comparison between pseudo-years', caption = 'Max/min/mean/median are calculated day by day in period 2009-2019 (for example, Max is the worse case scenario from that period)') +
  theme(axis.text.x = element_text(angle = 45, hjust = 0))
```

```{r, child='_header.md'}
```