---
title: "COVID-19 Portugal data"
output: 
  html_document:
    toc: true
    dev: svg
---

```{r, eval=FALSE, include=FALSE}
rmarkdown::render('portugal.Rmd')
```

```{r, eval=FALSE, include=FALSE}
rmarkdown::clean_site()
rmarkdown::render_site(quiet = TRUE)
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
devtools::load_all()
library(pdftools)
library(rvest)
library(dplyr)
library(tibble)
library(DT)
library(anytime)
library(glue)
library(reshape2)
library(zoo)
library(xml2)
library(usethis)
library(ggplot2)
library(ggrepel)
library(plotly)
library(viridis)

Sys.setlocale('LC_TIME', 'en_GB.UTF-8')
```

```{r, include=FALSE}
BiocManager::install('averissimo/covid19.pt.data')
library(covid19.pt.data)
```

```{r child='_header.md'}
```

```{r, message=FALSE, include=FALSE}
dat    <- download.updated.pt()
dgs.pt <- dat$dgs.pt
covid19.pt  <- dat$cdc.eu
```

```{r, include=FALSE}
age.data <- get.age.data(dgs.pt)
```

## Cumulative data for Portugal

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=7}
my.plot.data <- dgs.pt %>% 
  reshape2::melt(id.vars = c('country', 'date'), variable.name = 'type', measure.vars = c('tests', 'deaths', 'confirmed', 'hospitalized', 'in.icu', 'recovered')) %>% 
  filter(!is.na(value)) %>% 
  mutate(type = 
           gsub('confirmed', 'Confirmed cases', type) %>% 
           gsub('deaths', 'Deaths', .) %>% 
           gsub('recovered', 'Recovered', .) %>% 
           gsub('hospitalized', 'Hospitalized', .) %>% 
           gsub('in.icu', 'In ICU', .) %>% 
           gsub('tests', 'Tests', .)) %>% 
  mutate(text = format(value, big.mark = ',', trim = TRUE)) %>%
  ungroup() %>% 
  select(Date = date, Type = type, value = value, text = text) %>% 
  arrange(Date) 

d <- my.plot.data  %>%  
  highlight_key(~Type)

pal <- viridis(my.plot.data$Type %>% length, end = .8, option = 'A')

d %>% plot_ly() %>% 
  add_trace(x = ~Date, 
            y = ~value, 
            color = ~Type, 
            type = 'scatter',
            mode = 'lines+markers', 
            colors = pal, 
            name = ~Type,
            customdata = ~text,
            hovertemplate = paste0('<b>%{customdata}</b>', '<br><i>%{text}</i>', '<br><i>%{x}</i>'),
            text = ~Type
            ) %>% 
  layout(legend = list(x = 0.1, y = 1), dragmode = FALSE,
         title = 'Individuals that were Infected, Recovered and Died',
         xaxis = list(title = 'Date'),
         yaxis = list(title = 'Number of individuals', type = 'log')) %>% 
  highlight(on = 'plotly_click', off = 'plotly_doubleclick')
```

## Data per day

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=7}
my.plot.data <- dgs.pt %>% 
  reshape2::melt(id.vars = c('country', 'date'), variable.name = 'type', measure.vars = c('tests', 'deaths', 'confirmed', 'hospitalized', 'in.icu', 'recovered')) %>% 
  filter(!is.na(value)) %>% 
  mutate(type = 
           gsub('confirmed', 'Confirmed cases', type) %>% 
           gsub('deaths', 'Deaths', .) %>% 
           gsub('recovered', 'Recovered', .) %>% 
           gsub('hospitalized', 'Hospitalized', .) %>% 
           gsub('in.icu', 'In ICU', .) %>% 
           gsub('tests', 'Tests', .)) %>% 
  group_by(country, type) %>% 
  arrange(desc(date)) %>% 
  mutate(value = zoo::rollapply(value, 2, function(ix) { if(length(ix) <= 1) { return(ix) } else { ix[1] - sum(ix[-1]) } }, fill = c(0, 0, 0), align = 'left', partial = TRUE)) %>%
  mutate(text = format(value, big.mark = ',', trim = TRUE)) %>%
  ungroup() %>% 
  #filter(value != 0) %>% 
  select(Date = date, Type = type, value = value, text = text) %>% 
  arrange(Date) 

d <- my.plot.data  %>%  
  highlight_key(~Type)

pal <- viridis(my.plot.data$Type %>% length, end = .8, option = 'A')

d %>% plot_ly() %>% 
  add_trace(x = ~Date, 
            y = ~value, 
            color = ~Type, 
            type = 'scatter',
            mode = 'lines+markers', 
            colors = pal, 
            name = ~Type,
            customdata = ~text,
            hovertemplate = paste0('<b>%{customdata}</b>', '<br><i>%{text}</i>', '<br><i>%{x}</i>'),
            text = ~Type
            ) %>% 
  layout(legend = list(x = 0.1, y = 1), dragmode = FALSE,
         title = 'Individuals that were Infected, Recovered and Died',
         xaxis = list(title = 'Date'),
         yaxis = list(title = 'Number of individuals')) %>% 
  highlight(on = 'plotly_click', off = 'plotly_doubleclick')
```

# Cases / Deaths by age groups {.tabset .tabset-fade .tabset-pills}

```{r, results='asis', echo=FALSE,fig.width=4.5, warning=FALSE}
ixs <- unique(age.data %>% arrange(desc(date)) %>% pull(date))

confirmed.max <- age.data %>% filter(age_type == 'confirmed') %>%  pull(value) %>% max
death.max <- age.data %>% filter(age_type == 'death') %>%  pull(value) %>% max
for (age.ix in seq_along(ixs)) {
  age.ix.f <- ixs[age.ix]
  cat('\n')
  cat('\n')
  cat('## {age.ix.f}' %>% glue)
  cat('\n')
  cat('\n')
  age.data.all <- get.age.data.with.labels(age.data, age.ix.f)
  my.plots.all <- get.plot.for.all(age.data.all, age.ix.f, confirmed.max, death.max)
  print(my.plots.all$confirmed)
  print(my.plots.all$deaths)
  cat('\n')
  cat('\n')
}
```

# New Cases / Deaths by age groups {.tabset .tabset-fade .tabset-pills}


```{r, results='asis', echo=FALSE,fig.width=4.5, warning=FALSE}
age.data.all.new.tmp <- age.data %>% 
  group_by(country, type, gender, age_type) %>% 
  arrange(desc(date)) %>% 
  mutate(value = zoo::rollapply(value, 2, function(ix) { if(length(ix) <= 1) { return(ix) } else { ix[1] - sum(ix[-1]) } }, fill = c(0, 0, 0), align = 'left', partial = TRUE)) %>%
  filter(value != 0) %>% 
  filter(date != min(date)) # ignore first day as it shows cumulative cases from before!

ixs <- unique(age.data.all.new.tmp %>% arrange(desc(date)) %>% pull(date))

confirmed.max <- age.data.all.new.tmp %>% filter(age_type == 'confirmed') %>%  pull(value) %>% max
death.max <- age.data.all.new.tmp %>% filter(age_type == 'death') %>%  pull(value) %>% max

for (age.ix in seq_along(ixs)) {
  age.ix.f <- ixs[age.ix]
  

  cat('\n')
  cat('\n')
  cat('## {age.ix.f}' %>% glue)
  cat('\n')
  cat('\n')
  #
  #
  #
  #
  #
  #
  age.data.all <- get.age.data.with.labels(age.data, age.ix.f)

  age.data.all.new <- get.age.new.data(age.data, age.data.all, age.ix.f)
  my.plots.new <- get.plot.for.new(age.data.all.new, age.ix.f, confirmed.max, death.max)
  print(my.plots.new$confirmed)
  print(my.plots.new$deaths)
  cat('\n')
  cat('\n')
}
```

```{r, eval=FALSE, include=FALSE}
# Predicted deaths based on cases and current mortality rate

# note that the predicted deaths are for the future as a result of the confirmed cases on that day
plot_ly() %>% 
  add_trace(x = ~date, y = ~predicted, data = dat.predicted, mode = 'scatter+lines')

dat.pred.tmp <- dat.predicted %>% mutate(deaths = predicted) %>% 
  select(date, deaths) %>% 
  arrange(date) %>% 
  mutate(deaths = cumsum(deaths))

tmp.dat <- dgs.pt %>% select(date, deaths) %>% 
  inner_join(dat.pred.tmp, by = 'date', suffix = c('.dgs', '.predicted')) %>% 
  melt(id.vars = 'date')

plot_ly() %>% 
  add_trace(x = ~date, y = ~value, data = tmp.dat, color = ~variable, mode = 'markers+lines', type = 'scatter')


```


# Data {.tabset .tabset-fade .tabset-pills}

## Data from DGS

```{r, echo=FALSE}
dgs.pt %>% arrange(desc(date)) %>%  datatable()
```

## Data from EU CDC updated

```{r, message=FALSE, echo=FALSE}
covid19.pt %>% datatable()
```




